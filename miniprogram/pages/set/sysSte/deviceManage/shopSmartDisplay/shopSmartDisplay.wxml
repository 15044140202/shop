<!--pages/set/sysSte/deviceManage/shopSmartDisplay/shopSmartDisplay.wxml-->
<wxs src="../../../../../utils/tool.wxs" module="tool" />
<view class="page-header" style="height: 8vh;">
  <view class="header-title">æ™ºæ…§å¤§å±ç®¡ç†</view>
  <view class="header-intro">æ·»åŠ ç®¡ç†(å§å°æ™ºæ…§å±,å¤§å…å…¬å…±æ™ºæ…§å±,æ¡Œå°æ™ºæ…§å±,æ™ºæ…§å¹¿å‘Šæœº.)</view>
</view>
<!-- pages/deviceManage/deviceManage.wxml -->
<view class="container2">
  <!-- è®¾å¤‡ç»Ÿè®¡å¡ç‰‡ --> 
  <view class="stats-card">
    <view class="stat-item" bind:tap="tap" mark:item="filterDevice" mark:onlineState="{{2}}">
      <text class="stat-value">{{shopSmartDisplay.length}}</text>
      <text class="stat-label">è®¾å¤‡æ€»æ•°</text>
    </view>
    <view class="stat-item" bind:tap="tap" mark:item="filterDevice" mark:onlineState="{{1}}">
      <text class="stat-value">{{onlineCount || 0}}</text>
      <text class="stat-label online">åœ¨çº¿è®¾å¤‡</text>
    </view>
    <view class="stat-item" bind:tap="tap" mark:item="filterDevice" mark:onlineState="{{0}}">
      <text class="stat-value">{{offlineCount || 0}}</text>
      <text class="stat-label offline">ç¦»çº¿è®¾å¤‡</text>
    </view>
  </view>

  <!-- è®¾å¤‡åˆ—è¡¨ -->
  <view class="device-list">
    <view wx:for="{{filteredDevices}}" wx:key="deviceMac" class="device-item {{selectedDevice && selectedDevice.deviceMac === item.deviceMac ? 'selected' : ''}}" bindtap="onDeviceClick" data-device="{{item}}">
      <view class="device-info">
        <view class="device-name">
          {{item.name}}
          <text class="device-status {{item.online ? 'online' : 'offline'}}">{{item.online ? 'åœ¨çº¿' : 'ç¦»çº¿'}}</text>
        </view>
        <view class="device-details">
          <text wx:if="{{item.name === 'æ¡Œå°æ™ºæ…§å±'}}" class="detail-item">æ¡Œå°: {{item.tableNum ? item.tableNum + 'å·å°' : 'æœªç»‘å®š'}}</text>
          <text class="detail-item">æœ€åä½¿ç”¨: {{tool.timeStampToStr(item.lastUsedTime)}}</text>
        </view>
      </view>
      <view class="device-actions">
        <van-icon name="ellipsis" size="22rpx" color="#888" />
      </view>
    </view>
  </view>

  <!-- è®¾å¤‡è¯¦æƒ…å¼¹çª— -->
  <van-popup show="{{showDeviceDetail}}" position="bottom" round custom-style="height: 850vh; max-height: 700rpx;" bind:close="onCloseDetail">
    <view class="detail-header">
      <text class="detail-title">{{selectedDevice.name || 'è®¾å¤‡è¯¦æƒ…'}}</text>
      <van-icon name="delete" size="45rpx" color="#f5222d" bind:click="onDeleteDevice" class="delete-icon" />
    </view>

    <view class="detail-content">
      <view class="detail-row">
        <text class="row-label">æˆæƒç :</text>
        <canvas class="barcode-canvas" canvas-id="barCode"></canvas>
      </view>
      <view wx:if="{{selectedDevice.name === 'æ¡Œå°æ™ºæ…§å±'}}" class="detail-row">
        <text class="row-label">ç»‘å®šæ¡Œå°:</text>
        <picker mode="selector" range="{{shop_table}}" range-key="tableNum" bindchange="bindtablechange" >
          <text class="row-value">{{selectedDevice.tableNum ? selectedDevice.tableNum + 'å·å°' : 'æœªç»‘å®š'}}</text>
        </picker>
      </view>
      <view style="width: 100%; height: 200rpx;"></view>
    </view>
  </van-popup>

  <!-- æ·»åŠ è®¾å¤‡æŒ‰é’® -->
  <view class="add-device-btn">
    <view class="main-btn" bindtap="showAddMenu">
      <text class="btn-text">+</text>
    </view>

    <view wx:if="{{showAddMenu}}" class="add-menu">
      <view class="menu-item" bindtap="onScanAdd">
        <text class="item-icon">ğŸ”</text>
        <text class="item-text">æ‰«ç æ·»åŠ </text>
      </view>
    </view>
  </view>
</view>